# ============================================================
# Azure DevOps Pipeline – Selenium Automation
# Author: Sana Ansari
#
# Purpose:
# - Run Selenium TestNG automation
# - Generate Extent HTML report
# - Capture step-level screenshots (Base64)
# - Publish reports as pipeline artifacts
# ============================================================

trigger:
  - main

# ------------------------------------------------------------
# Use self-hosted agent (your laptop)
# ------------------------------------------------------------
pool:
  name: Default

steps:

  # ------------------------------------------------------------
  # STEP 1: Verify Java installation
  # ------------------------------------------------------------
  - script: |
      echo JAVA_HOME=%JAVA_HOME%
      where java
      java -version
    displayName: 'Verify Java Version'

  # ------------------------------------------------------------
  # STEP 2: Verify Maven installation
  # ------------------------------------------------------------
  - script: |
      where mvn
      mvn -version
    displayName: 'Verify Maven Version'

  # ------------------------------------------------------------
  # STEP 3: Build & Run Selenium Tests
  # ------------------------------------------------------------
  - script: |
      mvn clean test
    displayName: 'Build & Run Selenium Tests'

  # ------------------------------------------------------------
  # STEP 4: Publish TestNG / JUnit Results to Azure UI
  # ------------------------------------------------------------
  - task: PublishTestResults@2
    displayName: 'Publish Test Results'
    condition: succeededOrFailed()
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: '**/surefire-reports/TEST-*.xml'
      mergeTestResults: true

  # ------------------------------------------------------------
  # STEP 5: Publish Automation Reports (SAFE – Option 1)
  # ------------------------------------------------------------
  # WHY:
  # - Prevents "Path not found" errors
  # - Ensures Extent report + screenshots are always available
  # - Best practice for CI pipelines
  # ------------------------------------------------------------
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Automation Reports'
    condition: succeededOrFailed()
    inputs:
      PathtoPublish: '$(System.DefaultWorkingDirectory)'
      ArtifactName: 'automation-test-reports'
      publishLocation: 'Container'